#!/bin/bash

WALLPAPER_DIR="$HOME/wallpapers"
TEMPFILE="/tmp/yazi-wallpaper-choice"

while true; do
    rm -f "$TEMPFILE"
    yazi "$WALLPAPER_DIR" --chooser-file="$TEMPFILE"
    
    [ -f "$TEMPFILE" ] || break

    SELECTED=$(cat "$TEMPFILE")
    [ -n "$SELECTED" ] || break

    swww img --transition-fps 60 --transition-type outer --transition-step 90 --transition-pos 0.854,0.997 "$SELECTED"

    (
        matugen image "$SELECTED" -t scheme-vibrant &
        walcord &
        swaync-client --reload-css &
        rm -f "$WALLPAPER_DIR/blurred.png"
        convert "$SELECTED" -blur 0x30 -modulate 100,70 "$WALLPAPER_DIR/blurred.png"
        swww img -n overlay "$WALLPAPER_DIR/blurred.png"
    ) >/dev/null 2>&1 & disown

    break
done
